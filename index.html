<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scrib App</title>
    
    <!-- PWA / App Install Support -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Scrib">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #ffffff;
            --bg-sidebar: #f8f9fa;
            --bg-card: #ffffff;
            --bg-hover: #f1f3f4;
            --text-main: #1f1f1f;
            --text-muted: #5f6368;
            --border-color: transparent; 
            --accent-color: #1a73e8;
            --accent-hover: #174ea6;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --font-family: 'Inter', sans-serif;
            --sidebar-width: 260px;
        }

        [data-theme="dark"] {
            --bg-body: #202124;
            --bg-sidebar: #292a2d;
            --bg-card: #202124;
            --bg-hover: #3c4043;
            --text-main: #e8eaed;
            --text-muted: #9aa0a6;
            --accent-color: #8ab4f8;
            --accent-hover: #aecbfa;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1rem;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-bottom: 4px;
            transition: all 0.2s;
        }
        .nav-item:hover { background-color: var(--bg-hover); color: var(--text-main); }
        .nav-item.active { background-color: var(--bg-hover); color: var(--text-main); font-weight: 600; }
        .nav-item svg { width: 18px; height: 18px; margin-right: 12px; }

        .logo {
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 2rem;
            padding-left: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
            user-select: none;
        }

        /* --- Main Content --- */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-body);
            box-shadow: -5px 0 15px rgba(0,0,0,0.02);
        }

        /* --- Header --- */
        header {
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-body);
        }
        
        .header-controls { display: flex; gap: 20px; align-items: center; font-size: 0.9rem; }
        
        .realtime-clock {
            font-family: monospace;
            background: var(--bg-hover);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .search-bar {
            background: var(--bg-hover);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            width: 250px;
            color: var(--text-main);
        }
        .search-bar::placeholder { color: var(--text-muted); }

        .btn-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .btn-icon:hover { background-color: var(--bg-hover); color: var(--text-main); }

        /* --- View Container --- */
        #view-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 3rem;
        }

        /* --- Typography --- */
        h1 { margin-top: 0; margin-bottom: 2rem; font-weight: 600; }
        
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        /* --- Card --- */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: var(--shadow-sm);
            border: 1px solid transparent;
        }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        
        .card-tag {
            font-size: 0.75rem;
            color: var(--accent-color);
            background: rgba(26, 115, 232, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            align-self: flex-start;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main); }
        .card-desc { font-size: 0.95rem; color: var(--text-muted); line-height: 1.6; flex: 1; }
        .card-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; }

        .status-badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }
        .is-draft { color: var(--text-muted); background: var(--bg-hover); }
        .is-published { color: var(--accent-color); background: rgba(26, 115, 232, 0.1); }
        .is-private { color: #f9ab00; background: rgba(249, 171, 0, 0.1); }

        /* --- Forms --- */
        .editor-form { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: var(--text-muted); }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--bg-hover);
            border-radius: 8px;
            background: var(--bg-body);
            color: var(--text-main);
            font-family: inherit;
            font-size: 1rem;
            transition: border 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        .form-textarea { min-height: 300px; resize: vertical; line-height: 1.6; }
        
        .btn-primary {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: background 0.2s;
        }
        .btn-primary:hover { background: var(--accent-hover); }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-main);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
        }
        .btn-secondary:hover { background: #e0e0e0; }

        /* --- Timer Specific --- */
        .timer-container {
            text-align: center;
            padding: 3rem;
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: var(--shadow-sm);
        }
        .timer-display {
            font-size: 5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--text-main);
            margin: 1rem 0;
        }
        .timer-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 2rem;
        }
        .timer-inputs input {
            width: 80px;
            padding: 10px;
            text-align: center;
            font-size: 1.2rem;
            border: 1px solid var(--bg-hover);
            border-radius: 8px;
        }

        /* --- Images in Note Content --- */
        .note-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: var(--shadow-sm);
        }

        /* --- Mobile --- */
        .mobile-menu-btn { display: none; }
        @media (max-width: 768px) {
            #sidebar { position: fixed; left: -100%; height: 100%; z-index: 99; width: 80%; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            #sidebar.open { left: 0; }
            .mobile-menu-btn { display: block; margin-right: 15px; }
            #view-container { padding: 1.5rem; }
            .timer-display { font-size: 3.5rem; }
            .header-controls { gap: 10px; }
            .search-bar { width: 140px; }
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<aside id="sidebar">
    <div class="logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>
        Scrib
    </div>
    
    <a href="#" class="nav-item active" onclick="router('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        Home
    </a>
    <a href="#" class="nav-item" onclick="router('all-notes')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        All Notes (Public)
    </a>
    <a href="#" class="nav-item" onclick="router('private-notes')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        Private Notes
    </a>
    <a href="#" class="nav-item" onclick="router('drafts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        Drafts
    </a>

    <div style="margin-top: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--bg-hover);"></div>

    <a href="#" class="nav-item" onclick="router('student-notes')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
        Student Notes
    </a>
    <a href="#" class="nav-item" onclick="router('trip-plan')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/></svg>
        Trip Plan
    </a>
    <a href="#" class="nav-item" onclick="router('focus-timer')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        Focus Timer
    </a>

    <div style="margin-top: auto;">
        <a href="#" class="nav-item" onclick="router('editor')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Create New
        </a>
    </div>
</aside>

<!-- Main Content -->
<main id="main-content">
    <header>
        <div class="logo mobile-menu-btn" onclick="toggleSidebar()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </div>
        <div class="header-controls">
            <div class="realtime-clock" id="clock">00:00:00</div>
            <input type="text" class="search-bar" placeholder="Search..." oninput="handleSearch(this.value)">
            <button class="btn-icon" onclick="toggleTheme()" title="Toggle Dark Mode">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </div>
    </header>

    <div id="view-container">
        <!-- Content injected via JS -->
    </div>
</main>

<script>
    /* --- STATE MANAGEMENT --- */
    const state = {
        notes: [],
        settings: {
            theme: 'light'
        },
        timer: {
            interval: null,
            totalSeconds: 0,
            isRunning: false
        }
    };

    /* --- INITIALIZATION --- */
    function init() {
        const storedNotes = localStorage.getItem('scrib_notes_v5');
        
        if (storedNotes) {
            state.notes = JSON.parse(storedNotes);
        } else {
            state.notes = [];
        }

        // Request notification permission early
        if ("Notification" in window) {
            Notification.requestPermission();
        }

        startClock();
        router('home');
    }

    function saveData() {
        localStorage.setItem('scrib_notes_v5', JSON.stringify(state.notes));
    }

    /* --- CLOCK --- */
    function startClock() {
        const updateTime = () => {
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock').innerText = `${dateStr} ${timeStr}`;
        };
        updateTime();
        setInterval(updateTime, 1000);
    }

    /* --- ROUTER --- */
    function router(route, param = null) {
        const container = document.getElementById('view-container');
        container.innerHTML = ''; 
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navs = document.querySelectorAll(`.nav-item[onclick="router('${route}')"]`);
        if(navs.length) navs[0].classList.add('active');

        document.getElementById('sidebar').classList.remove('open');

        switch(route) {
            case 'home': renderHome(container); break;
            case 'all-notes': renderFilteredNotes(container, 'published', 'public'); break;
            case 'private-notes': renderFilteredNotes(container, 'published', 'private'); break;
            case 'drafts': renderFilteredNotes(container, 'draft', null); break;
            case 'student-notes': renderCategoryNotes(container, 'student'); break;
            case 'trip-plan': renderCategoryNotes(container, 'trip'); break;
            case 'focus-timer': renderTimer(container); break;
            case 'note': renderNoteDetail(container, param); break;
            case 'editor': renderEditor(container, param); break;
            default: renderHome(container);
        }
    }

    /* --- RENDERERS --- */

    function renderHome(container) {
        const sortedNotes = [...state.notes].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        const recent = sortedNotes.slice(0, 3); 

        container.innerHTML = `
            <div class="editor-form">
                <h1>Welcome to Scrib</h1>
                
                <div class="grid-layout" style="margin-bottom:3rem;">
                    <div class="card" style="justify-content:center; text-align:center; border:2px dashed var(--bg-hover);" onclick="router('editor')">
                        <div style="font-size:3rem; color:var(--accent-color); margin-bottom:0.5rem;">+</div>
                        <div>Create Note</div>
                    </div>
                </div>

                <h2>Recent Notes</h2>
                ${recent.length === 0 ? 
                    `<div class="empty-state" style="text-align:center; padding:2rem; color:var(--text-muted);"><h3>No notes yet</h3><p>Create your first note to get started.</p></div>` : 
                    `<div class="grid-layout">${recent.map(note => createNoteCard(note)).join('')}</div>`
                }
            </div>
        `;
    }

    function renderTimer(container) {
        container.innerHTML = `
            <div class="timer-container">
                <h1>Focus Timer</h1>
                <p style="color:var(--text-muted)">Set a time to focus. We'll alert you when it's done.</p>
                
                <div class="timer-display" id="timer-display">00:00</div>
                
                <div class="timer-inputs" id="timer-inputs">
                    <input type="number" id="timer-min" placeholder="Min" min="0" value="25">
                    <span style="font-size:2rem; margin-top:-10px;">:</span>
                    <input type="number" id="timer-sec" placeholder="Sec" min="0" max="59" value="00">
                </div>

                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn-primary" onclick="startTimer()">Start</button>
                    <button class="btn-secondary" onclick="resetTimer()">Reset</button>
                </div>
            </div>
        `;
    }

    /* --- TIMER LOGIC --- */
    function playBellSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.type = 'sine';
        osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
        osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1); // C6
        
        gain.gain.setValueAtTime(0.5, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1.5);

        osc.start();
        osc.stop(ctx.currentTime + 1.5);
    }

    function startTimer() {
        if(state.timer.isRunning) return;

        const min = parseInt(document.getElementById('timer-min').value) || 0;
        const sec = parseInt(document.getElementById('timer-sec').value) || 0;
        
        let totalSeconds = (min * 60) + sec;
        if(totalSeconds <= 0) return;

        state.timer.isRunning = true;
        document.getElementById('timer-inputs').style.display = 'none';

        state.timer.interval = setInterval(() => {
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;

            if(totalSeconds <= 0) {
                clearInterval(state.timer.interval);
                state.timer.isRunning = false;
                document.getElementById('timer-display').innerText = "Done!";
                playBellSound();
                sendNotification("Time's up!", "Your focus session is complete.");
                
                // Show inputs again after a delay
                setTimeout(() => {
                    document.getElementById('timer-inputs').style.display = 'flex';
                }, 3000);
            }
            totalSeconds--;
        }, 1000);
    }

    function resetTimer() {
        clearInterval(state.timer.interval);
        state.timer.isRunning = false;
        document.getElementById('timer-display').innerText = "00:00";
        document.getElementById('timer-inputs').style.display = 'flex';
        document.getElementById('timer-min').value = 25;
        document.getElementById('timer-sec').value = 0;
    }

    function sendNotification(title, body) {
        if (Notification.permission === "granted") {
            new Notification(title, { body: body, icon: 'https://picsum.photos/seed/icon/64/64' });
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification(title, { body: body });
                }
            });
        }
    }

    function renderFilteredNotes(container, status, visibility) {
        let filtered = state.notes.filter(n => n.status === status);
        if (visibility !== null) {
            filtered = filtered.filter(n => n.visibility === visibility);
        }
        const sorted = filtered.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

        const titleMap = {
            'published_public': 'All Public Notes',
            'published_private': 'Private Notes',
            'draft': 'Drafts'
        };

        container.innerHTML = `
            <div class="editor-form">
                <div class="flex-row" style="justify-content:space-between; margin-bottom:1rem;">
                    <h1>${titleMap[`${status}_${visibility}`] || 'Notes'}</h1>
                    <button class="btn-icon" onclick="router('editor')">+ New</button>
                </div>
                
                ${sorted.length === 0 ? 
                    `<div class="empty-state" style="text-align:center; padding:2rem; color:var(--text-muted);"><h3>No notes found</h3></div>` : 
                    `<div class="grid-layout">${sorted.map(note => createNoteCard(note)).join('')}</div>`
                }
            </div>
        `;
    }

    function renderCategoryNotes(container, category) {
        const filtered = state.notes.filter(n => n.category === category).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        
        const titleMap = {
            'student': 'Student Notes',
            'trip': 'Trip Plan'
        };

        container.innerHTML = `
            <div class="editor-form">
                <div class="flex-row" style="justify-content:space-between; margin-bottom:1rem;">
                    <h1>${titleMap[category] || 'Notes'}</h1>
                    <button class="btn-icon" onclick="router('editor')">+ New</button>
                </div>
                
                ${filtered.length === 0 ? 
                    `<div class="empty-state" style="text-align:center; padding:2rem; color:var(--text-muted);"><h3>No notes in this category</h3><p>Select this category when creating a note.</p></div>` : 
                    `<div class="grid-layout">${filtered.map(note => createNoteCard(note)).join('')}</div>`
                }
            </div>
        `;
    }

    function createNoteCard(note) {
        let statusBadge = '';
        if(note.status === 'draft') {
            statusBadge = `<span class="status-badge is-draft">Draft</span>`;
        } else if(note.visibility === 'private') {
            statusBadge = `<span class="status-badge is-private">Private</span>`;
        } else {
            statusBadge = `<span class="status-badge is-published">Public</span>`;
        }

        const subjectText = note.subject ? note.subject : 'No Subject';

        return `
            <div class="card" onclick="router('note', ${note.id})">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <span class="card-tag" style="background:var(--bg-hover); color:var(--text-muted);">${subjectText}</span>
                    ${statusBadge}
                </div>
                <div class="card-title">${note.title || 'Untitled'}</div>
                <div class="card-desc">${note.content.replace(/<[^>]*>?/gm, '').substring(0, 80)}...</div>
                <div class="card-meta">
                    <span>${new Date(note.updatedAt).toLocaleDateString()}</span>
                </div>
            </div>
        `;
    }

    function renderNoteDetail(container, id) {
        const note = state.notes.find(n => n.id === id);
        if(!note) return container.innerHTML = "Note not found.";

        container.innerHTML = `
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:10px;" class="no-print">
                <button class="btn-icon" onclick="router('editor', ${note.id})" title="Edit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="btn-icon" style="color:var(--danger-color)" onclick="deleteNote(${note.id})">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>

            <div class="editor-form">
                <div style="color:var(--text-muted); font-size:0.9rem; margin-bottom:0.5rem; text-transform:uppercase; font-weight:600;">
                    ${note.status} ${note.visibility === 'private' ? '• Private' : '• Public'} • ${note.subject || 'General'}
                </div>
                <h1 style="font-size:2.5rem; margin: 0.5rem 0;">${note.title || 'Untitled'}</h1>
                <div style="margin-bottom:2rem; color:var(--text-muted); font-size:0.85rem;">
                    Last edited: ${new Date(note.updatedAt).toLocaleString()}
                </div>
                <div class="note-content" style="font-size:1.1rem; line-height:1.7; min-height:200px;">
                    ${note.content || '<p style="color:var(--text-muted)">No content...</p>'}
                </div>
            </div>
        `;
    }

    function renderEditor(container, id = null) {
        const note = id ? state.notes.find(n => n.id === id) : {
            title: '', 
            subject: '', 
            category: 'general',
            content: '', 
            status: 'draft', 
            visibility: 'private'
        };
        
        container.innerHTML = `
            <div class="editor-form">
                <h1>${id ? 'Edit Note' : 'New Note'}</h1>
                
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="edit-title" class="form-input" value="${note.title}" placeholder="Enter title here...">
                </div>

                <div class="flex-row" style="flex-wrap:wrap; display:flex; gap:10px;">
                    <div class="form-group" style="flex:1; min-width:200px; margin-bottom:1.5rem;">
                        <label class="form-label">Subject</label>
                        <input type="text" id="edit-subject" class="form-input" value="${note.subject}" placeholder="e.g. Math, Work, Personal">
                    </div>
                    
                    <div class="form-group" style="flex:1; min-width:150px; margin-bottom:1.5rem;">
                        <label class="form-label">Category</label>
                        <select id="edit-category" class="form-select">
                            <option value="general" ${note.category === 'general' ? 'selected' : ''}>General</option>
                            <option value="student" ${note.category === 'student' ? 'selected' : ''}>Student</option>
                            <option value="trip" ${note.category === 'trip' ? 'selected' : ''}>Trip Plan</option>
                        </select>
                    </div>

                    <div class="form-group" style="flex:1; min-width:150px; margin-bottom:1.5rem;">
                        <label class="form-label">Status</label>
                        <select id="edit-status" class="form-select">
                            <option value="draft" ${note.status === 'draft' ? 'selected' : ''}>Draft</option>
                            <option value="published" ${note.status === 'published' ? 'selected' : ''}>Published</option>
                        </select>
                    </div>

                    <div class="form-group" style="flex:1; min-width:150px; margin-bottom:1.5rem;">
                        <label class="form-label">Visibility</label>
                        <select id="edit-visibility" class="form-select">
                            <option value="private" ${note.visibility === 'private' ? 'selected' : ''}>Private</option>
                            <option value="public" ${note.visibility === 'public' ? 'selected' : ''}>Public</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label class="form-label">Content</label>
                        <input type="file" id="image-upload" accept="image/*" style="display:none;" onchange="handleImageUpload()">
                        <button class="btn-secondary" style="font-size:0.8rem; padding:6px 12px;" onclick="document.getElementById('image-upload').click()">Attach Image</button>
                    </div>
                    <textarea id="edit-content" class="form-textarea" placeholder="Write your thoughts here...">${note.content}</textarea>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Images inserted will appear as &lt;img&gt; tags.</div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:2rem;">
                    <button class="btn-primary" onclick="saveNote(${id})">Save Note</button>
                    <button class="btn-secondary" onclick="router('home')">Cancel</button>
                </div>
            </div>
        `;
    }

    /* --- ACTIONS --- */

    function handleImageUpload() {
        const file = document.getElementById('image-upload').files[0];
        if (!file) return;

        // Limit size to 500KB to prevent LocalStorage crash
        if (file.size > 500 * 1024) {
            alert("Image is too large. Please upload an image under 500KB.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const textarea = document.getElementById('edit-content');
            // Insert the Base64 image tag
            const imgTag = `\n<img src="${e.target.result}" style="max-width:100%; border-radius:8px; margin:10px 0;">\n`;
            textarea.value += imgTag;
        };
        reader.readAsDataURL(file);
    }

    function saveNote(id) {
        const title = document.getElementById('edit-title').value;
        const subject = document.getElementById('edit-subject').value;
        const category = document.getElementById('edit-category').value;
        const content = document.getElementById('edit-content').value;
        const status = document.getElementById('edit-status').value;
        const visibility = document.getElementById('edit-visibility').value;
        const updatedAt = new Date().toISOString();

        const noteData = {
            id: id || Date.now(),
            title, 
            subject, 
            category,
            content, 
            status,
            visibility,
            updatedAt
        };

        if(id) {
            const index = state.notes.findIndex(n => n.id === id);
            state.notes[index] = noteData;
        } else {
            state.notes.unshift(noteData);
        }

        saveData();
        
        if(status === 'draft') {
            router('drafts');
        } else if(category === 'student') {
            router('student-notes');
        } else if(category === 'trip') {
            router('trip-plan');
        } else if (visibility === 'private') {
            router('private-notes');
        } else {
            router('all-notes');
        }
    }

    function deleteNote(id) {
        if(!confirm('Are you sure you want to delete this note?')) return;
        state.notes = state.notes.filter(n => n.id !== id);
        saveData();
        router('home');
    }

    /* --- UI HELPERS --- */
    function handleSearch(query) {
        const lowerQ = query.toLowerCase();
        const grid = document.querySelector('.grid-layout');
        if(grid) {
            const filtered = state.notes.filter(n => {
                const matchTitle = (n.title || '').toLowerCase().includes(lowerQ);
                const matchSubject = (n.subject || '').toLowerCase().includes(lowerQ);
                const matchContent = (n.content || '').toLowerCase().includes(lowerQ);
                return matchTitle || matchSubject || matchContent;
            });
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:2rem; color:var(--text-muted);">No results found.</div>`;
            } else {
                grid.innerHTML = filtered.map(note => createNoteCard(note)).join('');
            }
        }
    }

    function toggleTheme() {
        state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', state.settings.theme);
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    // Init App
    init();

</script>
</body>
</html>
